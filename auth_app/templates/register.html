{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro - EduConnect+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- ✅ reCAPTCHA v3 (no visible) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LeyVfgrAAAAAB5DRsBe_KfPoqC1XsTv9y32iL4a"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #0d6efd, #6c63ff);
      height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 0;
      overflow-y: auto;
      font-family: 'Poppins', sans-serif;
    }
    .card {
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      padding: 2rem;
      background: #fff;
      width: 100%;
      max-width: 500px;
      position: relative;
    }
    .btn-primary {
      border-radius: 25px;
      padding: 10px;
      background-color: #0d6efd;
      border: none;
      transition: 0.3s;
    }
    .btn-primary:hover { background-color: #004aad; }
    .alert { display: none; margin-bottom: 15px; }
    #password-match {
      font-size: 14px;
      margin-top: -8px;
      margin-bottom: 12px;
      font-weight: 500;
    }
    #password-strength {
      height: 6px;
      border-radius: 5px;
      background-color: #e0e0e0;
      margin-top: 5px;
      margin-bottom: 8px;
      transition: 0.3s;
      display: none;
    }
    #password-strength-bar {
      height: 100%;
      border-radius: 5px;
      width: 0%;
      transition: width 0.3s ease;
    }
    #strength-text {
      font-size: 13px;
      font-weight: 500;
      display: none;
    }
    /* reCAPTCHA v3 es invisible, no necesita estilos */
  </style>
</head>
<body>
  <div class="card">
    <h3 class="text-center mb-4 text-primary">Crear Cuenta</h3>
    <div id="register-alert" class="alert alert-danger"></div>

    <form id="register-form">
      {% csrf_token %}
      <input type="text" id="username" placeholder="Usuario" class="form-control mb-3" required>

      <input type="password" id="password1" placeholder="Contraseña" class="form-control mb-2" required>
      <div id="password-hint" class="text-muted" style="font-size: 9px;">
        Debe tener al menos 6 caracteres, una letra mayuscula, un número y un carácter especial (!@#$%&*).
      </div>
      <div id="password-strength">
        <div id="password-strength-bar"></div>
      </div>
      <div id="strength-text" class="mb-2"></div>

      <input type="password" id="password2" placeholder="Confirmar Contraseña" class="form-control mb-1" required>
      <div id="password-match"></div>

      <input type="text" id="nombre_completo" placeholder="Nombre y Apellido" class="form-control mb-3" required>
      <input type="text" id="alias" placeholder="Alias (opcional)" class="form-control mb-3">
      <input type="email" id="email" placeholder="Email" class="form-control mb-3" required>
      <input type="text" id="institucion" placeholder="Institución" class="form-control mb-3" required>

      <div class="mb-3">
        <select id="rol" class="form-select" required>
          <option value="estudiante" selected>Estudiante</option>
          <option value="profesor">Profesor</option>
        </select>
      </div>

      <div class="mb-3" id="semestre-field">
        <select id="semestre" class="form-select">
          <option value="" disabled selected>Selecciona tu semestre</option>
          {% for i in "12345678"|make_list %}
            <option value="{{ i }}º semestre">{{ i }}º semestre</option>
          {% endfor %}
        </select>
      </div>

      <!-- ✅ reCAPTCHA v3 es INVISIBLE - no hay elemento visual -->
      <div class="mb-3 text-center text-muted small">
        <i class="fas fa-shield-alt"></i> Protegido por reCAPTCHA
      </div>

      <button type="submit" class="btn btn-primary w-100" id="submit-btn">
        <span id="submit-text">Registrarse</span>
        <div id="submit-spinner" class="spinner-border spinner-border-sm d-none" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
      </button>
      <p class="mt-3 text-center">¿Ya tienes cuenta? <a href="{% url 'login' %}">Inicia sesión</a></p>
    </form>
  </div>

  <!-- ✅ Modal de éxito -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-success">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="successModalLabel">¡Registro exitoso!</h5>
        </div>
        <div class="modal-body text-center">
          <p>✅ Tus datos personales están protegidos y solo se usan con fines académicos dentro de EduConnect+.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ✅ FUNCIÓN PARA OBTENER CSRF TOKEN
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          }
        });
      }
      return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    
    // Variables del DOM
    const rolSelect = document.getElementById("rol");
    const semestreField = document.getElementById("semestre-field");
    const pass1 = document.getElementById("password1");
    const pass2 = document.getElementById("password2");
    const matchMsg = document.getElementById("password-match");
    const alertBox = document.getElementById("register-alert");
    const barContainer = document.getElementById("password-strength");
    const bar = document.getElementById("password-strength-bar");
    const text = document.getElementById("strength-text");
    const submitBtn = document.getElementById("submit-btn");
    const submitText = document.getElementById("submit-text");
    const submitSpinner = document.getElementById("submit-spinner");

    // ✅ FUNCIÓN PARA OBTENER TOKEN reCAPTCHA v3
    function getRecaptchaToken() {
      return new Promise((resolve, reject) => {
        grecaptcha.ready(function() {
          grecaptcha.execute('6LeyVfgrAAAAAB5DRsBe_KfPoqC1XsTv9y32iL4a', {action: 'register'})
            .then(function(token) {
              resolve(token);
            })
            .catch(function(error) {
              reject(error);
            });
        });
      });
    }

    // Funciones de validación
    function toggleSemestreField() {
      semestreField.style.display = rolSelect.value === "estudiante" ? "block" : "none";
    }
    
    toggleSemestreField();
    rolSelect.addEventListener("change", toggleSemestreField);

    function checkPasswordMatch() {
      if (!pass2.value) {
        matchMsg.textContent = "";
        return;
      }
      if (pass1.value === pass2.value) {
        matchMsg.textContent = "✅ Las contraseñas coinciden.";
        matchMsg.style.color = "green";
      } else {
        matchMsg.textContent = "❌ Las contraseñas no coinciden.";
        matchMsg.style.color = "red";
      }
    }

    pass1.addEventListener("input", () => {
      if (pass1.value.trim() !== "") {
        barContainer.style.display = "block";
        text.style.display = "block";
      } else {
        barContainer.style.display = "none";
        text.style.display = "none";
      }
      checkPasswordMatch();
      updateStrength();
    });
    
    pass2.addEventListener("input", checkPasswordMatch);

    function updateStrength() {
      const pass = pass1.value;
      let strength = 0;
      if (pass.length >= 6) strength++;
      if (/[A-Za-z]/.test(pass)) strength++;
      if (/[0-9]/.test(pass)) strength++;
      if (/[!@#$%^&*(),.?":{}|<>]/.test(pass)) strength++;

      switch (strength) {
        case 0:
        case 1:
          bar.style.width = "25%";
          bar.style.backgroundColor = "red";
          text.textContent = "Débil";
          text.style.color = "red";
          break;
        case 2:
          bar.style.width = "50%";
          bar.style.backgroundColor = "orange";
          text.textContent = "Media";
          text.style.color = "orange";
          break;
        case 3:
          bar.style.width = "75%";
          bar.style.backgroundColor = "#fbc02d";
          text.textContent = "Buena";
          text.style.color = "#fbc02d";
          break;
        case 4:
          bar.style.width = "100%";
          bar.style.backgroundColor = "green";
          text.textContent = "Fuerte";
          text.style.color = "green";
          break;
      }
    }

    function validarPassword(pass) {
      const tieneLetra = /[A-Za-z]/.test(pass);
      const tieneNumero = /[0-9]/.test(pass);
      const tieneEspecial = /[!@#$%^&*(),.?":{}|<>]/.test(pass);
      return pass.length >= 6 && tieneLetra && tieneNumero && tieneEspecial;
    }

    // ✅ FUNCIÓN REGISTER MEJORADA CON reCAPTCHA v3
    async function register() {
      alertBox.style.display = "none";
      
      // Mostrar loading
      submitText.classList.add("d-none");
      submitSpinner.classList.remove("d-none");
      submitBtn.disabled = true;

      // Validaciones básicas primero
      if (pass1.value !== pass2.value) {
        alertBox.style.display = "block";
        alertBox.innerText = "Las contraseñas no coinciden.";
        resetSubmitButton();
        return;
      }

      if (!validarPassword(pass1.value)) {
        alertBox.style.display = "block";
        alertBox.innerText = "La contraseña no cumple con los requisitos.";
        resetSubmitButton();
        return;
      }

      try {
        // ✅ Obtener token de reCAPTCHA v3
        const recaptchaToken = await getRecaptchaToken();
        
        if (!recaptchaToken) {
          alertBox.style.display = "block";
          alertBox.innerText = "Error de verificación de seguridad. Intenta nuevamente.";
          resetSubmitButton();
          return;
        }

        const data = {
          username: document.getElementById("username").value,
          password1: pass1.value,
          password2: pass2.value,
          nombre_completo: document.getElementById("nombre_completo").value,
          alias: document.getElementById("alias").value || null,
          email: document.getElementById("email").value,
          institucion: document.getElementById("institucion").value,
          rol: rolSelect.value,
          semestre: rolSelect.value === "estudiante" ? document.getElementById("semestre").value : null,
          "g-recaptcha-response": recaptchaToken  // ✅ Token v3
        };

        const resp = await fetch("{% url 'api_register_session' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify(data)
        });

        const respData = await resp.json();

        if (!resp.ok) {
          alertBox.style.display = "block";
          alertBox.innerText = respData.error || "Error al registrarse.";
        } else {
          // ✅ Mostrar modal de éxito
          const modal = new bootstrap.Modal(document.getElementById('successModal'));
          modal.show();

          // Esperar 4 segundos y redirigir
          setTimeout(() => {
            modal.hide();
            if (respData.rol === "profesor") {
              window.location.href = "{% url 'dashboard_profesor' %}";
            } else {
              window.location.href = "{% url 'dashboard_user' %}";
            }
          }, 4000);
        }
      } catch (error) {
        console.error('Error:', error);
        alertBox.style.display = "block";
        alertBox.innerText = "Error de conexión. Intenta nuevamente.";
      } finally {
        resetSubmitButton();
      }
    }

    function resetSubmitButton() {
      submitText.classList.remove("d-none");
      submitSpinner.classList.add("d-none");
      submitBtn.disabled = false;
    }

    document.getElementById("register-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      await register();
    });
  </script>
</body>
</html>