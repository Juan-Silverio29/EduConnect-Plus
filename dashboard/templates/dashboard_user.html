{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Usuario - EduConnect+</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f4f9ff; }
    .sidebar { height: 100vh; background: #0d1b2a; color: white; padding: 20px; }
    .sidebar h2 { font-size: 1.5rem; margin-bottom: 2rem; }
    .sidebar a { color: white; text-decoration: none; display: block; padding: 12px; margin-bottom: 10px; border-radius: 8px; font-weight: 500; }
    .sidebar a:hover, .sidebar a.active { background: #0d6efd; }
    .sidebar a.logout { background: #e63946; }
    .sidebar a.logout:hover { background: #c1121f; }
    .welcome-card { background: linear-gradient(135deg, #6c63ff, #3f37c9); color: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; font-weight: 500; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .stat-card h5 { margin-bottom: 10px; }
    .stat-blue { border-top: 5px solid #0d6efd; }
    .stat-green { border-top: 5px solid #2a9d8f; }
    .stat-orange { border-top: 5px solid #f77f00; }
    .stat-purple { border-top: 5px solid #9d4edd; }
    
    /* Estilos mejorados para el chat AI */
    #edu-ai-chat {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1050;
    }

    #edu-ai-toggle {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        position: relative;
    }

    #edu-ai-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 30px rgba(0,0,0,0.4);
    }

    #edu-ai-toggle.pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    #edu-ai-panel {
        display: none;
        width: 400px;
        height: 550px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        overflow: hidden;
        flex-direction: column;
        margin-bottom: 16px;
        border: 1px solid #e2e8f0;
    }

    #edu-ai-panel.show {
        display: flex !important;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    #edu-ai-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8fafc;
    }

    .message {
        margin-bottom: 16px;
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 85%;
        word-wrap: break-word;
        animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .user-message {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 6px;
    }

    .ai-message {
        background: white;
        color: #334155;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #edu-ai-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #64748b;
        padding: 4px;
        border-radius: 4px;
        transition: background 0.2s;
    }

    #edu-ai-close:hover {
        background: #f1f5f9;
    }

    #edu-ai-input {
        width: 100%;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    #edu-ai-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Estilos mejorados para recomendaciones */
    #sugerencias {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-top: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
    }

    #sugerencias h3 {
        color: #0d1b2a;
        margin-bottom: 20px;
        font-weight: 700;
        font-size: 1.5rem;
    }

    .rec-card {
        background: linear-gradient(135deg, #f8faff, #ffffff);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .rec-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }

    .rec-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: #3b82f6;
    }

    .rec-card h5 {
        color: #1e293b;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .rec-card .badge {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .rec-card .nivel {
        background: #f1f5f9;
        color: #475569;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .progress-ring {
        width: 40px;
        height: 40px;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.3s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <div class="sidebar">
      <h2>EduConnect</h2>
      <a href="#" class="active">üè† Dashboard</a>
      <a href="{% url 'lista_cursos' %}">üìò Cursos</a>
      <a href="{% url 'lista_recursos' %}">üìò Mis Recursos</a>
      <a href="{% url 'foros' %}">üí¨ Foros</a>
      <a href="{% url 'logros_recursos_completados' %}">üìä Mi Progreso</a>
      <a href="{% url 'configuracion' %}" class="dropdown-item">‚öôÔ∏è Configuraci√≥n</a>
      <a href="{% url 'logout' %}" class="logout">üö™ Cerrar Sesi√≥n</a>
    </div>

    <div class="p-4 flex-grow-1">
      <div class="welcome-card">
        <h2>üëã Hola, {{ user.username }}!</h2>
        <p>Bienvenido a tu panel personalizado de EduConnect üöÄ</p>
        <div class="mt-3">
          <span class="badge bg-light text-dark me-2">üìö 
            <span id="user-cursos-count">0</span> Cursos
          </span>
          <span class="badge bg-light text-dark me-2">‚úÖ 
            <span id="user-completados-count">0</span> Completados
          </span>
          <span class="badge bg-light text-dark">‚è±Ô∏è 
            <span id="user-tiempo-estudio">0</span>h Estudiadas
          </span>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">
          <div class="stat-card stat-blue">
            <h5>Recursos Completados</h5>
            <p class="display-6" id="stat-completados">0</p>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="stat-card stat-green">
            <h5>Tiempo de Estudio</h5>
            <p class="display-6" id="stat-tiempo">0h</p>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="stat-card stat-orange">
            <h5>Logros Obtenidos</h5>
            <p class="display-6" id="stat-logros">0</p>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="stat-card stat-purple">
            <h5>Recursos Nuevos</h5>
            <p class="display-6" id="stat-nuevos">0</p>
          </div>
        </div>
      </div>

      <!-- Secci√≥n de Recomendaciones Mejorada -->
      <section id="sugerencias">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>üéØ Recomendaciones Personalizadas</h3>
          <button id="refresh-recs" class="btn btn-outline-primary btn-sm">
            üîÑ Actualizar
          </button>
        </div>
        <div id="rec-cards" class="row g-4">
          <!-- Las recomendaciones se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </section>

      <!-- Progreso Reciente -->
      <div class="mt-5">
        <h4 class="mb-3">üìà Tu Progreso Reciente</h4>
        <div id="user-recursos" class="row g-3">
          <!-- Recursos del usuario se cargar√°n aqu√≠ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Chat AI Tutor Mejorado -->
  <div id="edu-ai-chat">
    <div id="edu-ai-panel">
      <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
        <div class="d-flex align-items-center">
          <div class="bg-primary rounded-circle p-2 me-2">
            <span style="color: white;">ü§ñ</span>
          </div>
          <div>
            <strong>EduConnect AI Tutor</strong>
            <div class="text-muted" style="font-size: 0.7rem;">En l√≠nea ‚Ä¢ Listo para ayudar</div>
          </div>
        </div>
        <button id="edu-ai-close" class="btn btn-sm">‚úï</button>
      </div>
      <div id="edu-ai-messages">
        <div class="message ai-message">
          <strong>¬°Hola {{ user.username }}! üëã</strong><br>
          Soy tu tutor AI de EduConnect. Puedo ayudarte con:
          <br>‚Ä¢ üìö Explicaciones de cursos
          <br>‚Ä¢ üí° Recomendaciones de estudio
          <br>‚Ä¢ üéØ Consejos de aprendizaje
          <br><br>¬øEn qu√© puedo ayudarte hoy?
        </div>
      </div>
      <div class="p-3 border-top bg-white">
        <form id="edu-ai-form" class="d-flex gap-2">
          <input id="edu-ai-input" type="text" class="form-control" 
                 placeholder="Escribe tu pregunta sobre cursos, materiales, etc...">
          <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
            Enviar
          </button>
        </form>
      </div>
    </div>
    <button id="edu-ai-toggle" class="pulse">ü§ñ</button>
  </div>

  <script>
    // Datos del usuario - usando valores por defecto seguros
    const userData = {
      username: "{{ user.username|default:'Usuario' }}",
      recursos: [],
      cursos: []
    };

    // Inicializaci√≥n cuando el DOM est√° listo
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar recomendaciones
      cargarRecomendaciones();
      
      // Inicializar chat AI
      inicializarChatAI();
      
      // Mostrar recursos del usuario
      mostrarRecursosUsuario();
      
      // Configurar evento de actualizaci√≥n
      document.getElementById('refresh-recs').addEventListener('click', cargarRecomendaciones);
      
      // Actualizar estad√≠sticas
      actualizarEstadisticas();
    });

    // Funci√≥n para actualizar estad√≠sticas
    function actualizarEstadisticas() {
      // Estos valores vendr√≠an de tu backend, por ahora usamos valores de ejemplo
      document.getElementById('stat-completados').textContent = '5';
      document.getElementById('stat-tiempo').textContent = '12h';
      document.getElementById('stat-logros').textContent = '3';
      document.getElementById('stat-nuevos').textContent = '2';
      
      document.getElementById('user-cursos-count').textContent = '3';
      document.getElementById('user-completados-count').textContent = '5';
      document.getElementById('user-tiempo-estudio').textContent = '12';
    }

    // Funci√≥n mejorada para cargar recomendaciones
    async function cargarRecomendaciones() {
      const recCards = document.getElementById('rec-cards');
      const refreshBtn = document.getElementById('refresh-recs');
      
      // Mostrar estado de carga
      recCards.innerHTML = `
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando recomendaciones...</span>
          </div>
          <p class="mt-2 text-muted">Buscando las mejores recomendaciones para ti...</p>
        </div>
      `;
      
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '‚è≥ Cargando...';

      try {
        // Intentar cargar recomendaciones reales
        const response = await fetch('/ai/recs/');
        
        if (response.ok) {
          const data = await response.json();
          mostrarRecomendaciones(data.recomendaciones || []);
        } else {
          throw new Error('Error en la respuesta del servidor');
        }
      } catch (error) {
        console.log('Usando recomendaciones de ejemplo:', error);
        // Recomendaciones de ejemplo mejoradas
        const recomendacionesEjemplo = [
          {
            titulo: "Python Avanzado: Data Science",
            descripcion: "Basado en tu progreso en Python b√°sico. Aprende pandas, numpy y matplotlib para an√°lisis de datos.",
            tipo: "Recomendado",
            nivel: "Intermedio",
            progreso: 75,
            duracion: "8 semanas",
            rating: 4.8
          },
          {
            titulo: "Machine Learning Fundamentals",
            descripcion: "Perfecto para seguir con inteligencia artificial. Incluye proyectos pr√°cticos con scikit-learn.",
            tipo: "Trending",
            nivel: "Intermedio-Avanzado",
            progreso: 30,
            duracion: "10 semanas",
            rating: 4.9
          },
          {
            titulo: "Desarrollo Web Full Stack",
            descripcion: "Domina React, Node.js y MongoDB. Construye aplicaciones web completas desde cero.",
            tipo: "Popular",
            nivel: "Avanzado",
            progreso: 10,
            duracion: "12 semanas",
            rating: 4.7
          },
          {
            titulo: "Matem√°ticas para AI",
            descripcion: "Refuerza tus bases matem√°ticas: √°lgebra lineal, c√°lculo y estad√≠stica aplicada a IA.",
            tipo: "Esencial",
            nivel: "Intermedio",
            progreso: 45,
            duracion: "6 semanas",
            rating: 4.6
          }
        ];
        mostrarRecomendaciones(recomendacionesEjemplo);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = 'üîÑ Actualizar';
      }
    }

    function mostrarRecomendaciones(recomendaciones) {
      const recCards = document.getElementById('rec-cards');
      
      if (recomendaciones.length === 0) {
        recCards.innerHTML = `
          <div class="col-12 text-center py-4">
            <p class="text-muted">No hay recomendaciones disponibles en este momento.</p>
          </div>
        `;
        return;
      }
      
      recCards.innerHTML = recomendaciones.map(rec => `
        <div class="col-md-6">
          <div class="rec-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h5>${rec.titulo}</h5>
              <span class="badge">${rec.tipo}</span>
            </div>
            <p class="mb-3 text-muted">${rec.descripcion}</p>
            
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="nivel me-2">${rec.nivel}</span>
                <small class="text-muted">${rec.duracion}</small>
              </div>
              <div class="d-flex align-items-center">
                <span class="text-warning me-1">‚≠ê</span>
                <small class="text-muted">${rec.rating}</small>
              </div>
            </div>
            
            ${rec.progreso ? `
            <div class="mt-3">
              <div class="d-flex justify-content-between mb-1">
                <small class="text-muted">Progreso</small>
                <small class="text-muted">${rec.progreso}%</small>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: ${rec.progreso}%; background: linear-gradient(135deg, #3b82f6, #8b5cf6);"
                     aria-valuenow="${rec.progreso}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // Funci√≥n para mostrar recursos del usuario
    function mostrarRecursosUsuario() {
      const recursosDiv = document.getElementById('user-recursos');
      
      // Datos de ejemplo para recursos
      const recursosEjemplo = [
        { nombre: "Introducci√≥n a Python", completado: true, fecha_completado: "2024-01-15" },
        { nombre: "Fundamentos de Django", completado: false, fecha_completado: null },
        { nombre: "Base de Datos SQL", completado: true, fecha_completado: "2024-01-20" }
      ];
      
      recursosDiv.innerHTML = recursosEjemplo.map(r => `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">${r.nombre}</h6>
              <p class="card-text">
                <small class="text-muted">Completado: ${r.completado ? "‚úÖ" : "‚è≥"}</small>
              </p>
              ${r.fecha_completado ? `
                <small class="text-muted">Finalizado: ${new Date(r.fecha_completado).toLocaleDateString()}</small>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // Funci√≥n mejorada para inicializar el chat AI
    function inicializarChatAI() {
      const chatContainer = document.getElementById('edu-ai-chat');
      const toggleBtn = document.getElementById('edu-ai-toggle');
      const closeBtn = document.getElementById('edu-ai-close');
      const chatPanel = document.getElementById('edu-ai-panel');
      const chatForm = document.getElementById('edu-ai-form');
      const chatInput = document.getElementById('edu-ai-input');
      const chatMessages = document.getElementById('edu-ai-messages');

      // Mostrar el chat para todos los usuarios
      chatContainer.style.display = 'block';

      // Toggle del chat con mejor UX
      toggleBtn.addEventListener('click', function() {
        const isOpening = !chatPanel.classList.contains('show');
        chatPanel.classList.toggle('show');
        
        if (isOpening) {
          toggleBtn.classList.remove('pulse');
          chatInput.focus();
        }
      });

      // Cerrar chat
      closeBtn.addEventListener('click', function() {
        chatPanel.classList.remove('show');
        toggleBtn.classList.add('pulse');
      });

      // Enviar mensaje mejorado
      chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        
        if (message) {
          // Agregar mensaje del usuario
          addMessage(message, 'user');
          chatInput.value = '';
          chatInput.disabled = true;
          
          try {
            // Mostrar indicador de typing
            const typingIndicator = addMessage('Escribiendo...', 'ai');
            typingIndicator.classList.add('typing');
            typingIndicator.innerHTML = '<em>El tutor est√° escribiendo...</em>';
            
            // Simular delay para respuesta
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Remover indicador de typing
            chatMessages.removeChild(typingIndicator);
            
            // Respuestas contextuales
            const responses = [
              `Basado en tu perfil ${userData.username}, te recomiendo revisar los materiales de Python avanzado. ¬øTe gustar√≠a que profundice en alg√∫n tema espec√≠fico?`,
              "Para tu nivel actual, sugiero practicar con ejercicios de proyectos reales. ¬øQuieres que te sugiera algunos?",
              "He notado que te interesa el desarrollo web. ¬øTe gustar√≠a que te explique alg√∫n concepto en particular?",
              "¬°Excelente pregunta! Esto se relaciona con lo que has estado estudiando. ¬øQuieres que te ayude con ejercicios pr√°cticos?"
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addMessage(randomResponse, 'ai');
            
          } catch (error) {
            console.error('Error en el chat:', error);
            addMessage("Lo siento, hubo un error procesando tu mensaje. Por favor intenta nuevamente.", 'ai');
          } finally {
            chatInput.disabled = false;
            chatInput.focus();
          }
        }
      });

      function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        if (sender === 'ai' && text.includes('Escribiendo')) {
          messageDiv.innerHTML = text;
        } else {
          messageDiv.textContent = text;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
      }
    }
  </script>
</body>
</html>